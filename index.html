<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML5 Offline Player (Glassmorphism + Neumorphism)</title>
    <style>
        :root {
            --primary-bg-color: rgba(20, 20, 20, 0.7);
            --text-color: #f0f0f0;
            --accent-color: #00aaff;
            --slider-track-color: rgba(255, 255, 255, 0.45);
            --slider-track-highlight-color: #777;
            --transparent-black-bg: rgba(0, 0, 0, 0.7);
            --transparent-white-bg: rgba(255, 255, 255, 0.7);
            --glass-border-color: rgba(255, 255, 255, 0.2);
            --glass-bg-color: rgba(45, 45, 45, 0.4);
            --glass-dark-bg-color: rgba(30, 30, 30, 0.6);
            --interactive-bg-color: rgba(0, 0, 0, 0.3);
            --dropdown-option-bg: #2a2a2a;
            --playlist-item-hover-bg: rgba(255, 255, 255, 0.1);
            --playlist-item-active-bg: rgba(0, 170, 255, 0.3);
            --playlist-width: 300px;
            --body-bg-color: #2a2a2e;
            --progress-filled-color: #ffffff;
            
            /* Neumorphism Shadows for Dark Theme */
            --neumorphic-shadow-light: rgba(255, 255, 255, 0.1);
            --neumorphic-shadow-dark: rgba(0, 0, 0, 0.5);
            --neumorphic-shadow: 6px 6px 14px var(--neumorphic-shadow-dark), -6px -6px 14px var(--neumorphic-shadow-light);
            --neumorphic-shadow-inset: inset 4px 4px 8px var(--neumorphic-shadow-dark), inset -4px -4px 8px var(--neumorphic-shadow-light);

            /* -- NEW: Variables for dynamic scaling -- */
            --controls-scale: 0.96;
            --settings-scale: 0.97;
        }

        body.light-theme {
            --primary-bg-color: rgba(240, 240, 240, 0.8);
            --text-color: #333;
            --accent-color: #0077cc;
            --slider-track-color: rgba(0, 0, 0, 0.2);
            --slider-track-highlight-color: #aaa;
            --glass-border-color: rgba(0, 0, 0, 0.1);
            --glass-bg-color: rgba(255, 255, 255, 0.6);
            --glass-dark-bg-color: rgba(235, 235, 235, 0.75);
            --interactive-bg-color: rgba(0, 0, 0, 0.1);
            --dropdown-option-bg: #f0f0f0;
            --playlist-item-hover-bg: rgba(0, 0, 0, 0.05);
            --playlist-item-active-bg: rgba(0, 119, 204, 0.2);
            --body-bg-color: #e0e5ec;
            --progress-filled-color: #333;

            /* Neumorphism Shadows for Light Theme */
            --neumorphic-shadow-light: #ffffff;
            --neumorphic-shadow-dark: rgba(55, 84, 170, 0.15);
            --neumorphic-shadow: 7px 7px 15px var(--neumorphic-shadow-dark), -7px -7px 15px var(--neumorphic-shadow-light);
            --neumorphic-shadow-inset: inset 5px 5px 10px var(--neumorphic-shadow-dark), inset -5px -5px 10px var(--neumorphic-shadow-light);
        }


        body {
            font-family: 'Sahel', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--body-bg-color);
            color: var(--text-color);
            margin: 0;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        *:focus { outline: none; }

        .player-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: width 0.3s ease-in-out, margin-left 0.3s ease-in-out;
        }

        video { width: 100%; height: 100%; outline: none; }
        video.inverted {
            filter: invert(1);
            transition: filter 0.3s ease;
        }

        .subtitle-display {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 84%;
            max-width: 90%;
            text-align: center;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            pointer-events: none;
            line-height: 1.6;
            transition: width 0.3s ease-in-out, margin-left 0.3s ease-in-out, transform 0.1s linear;
        }

        .subtitle-display span {
            border-radius: 5px;
            -webkit-box-decoration-break: clone;
            box-decoration-break: clone;
            padding: 0;
            background-color: transparent;
        }

        .subtitle-display.has-bg-black span { background-color: var(--transparent-black-bg); padding: 0.15em 0.5em; }
        .subtitle-display.has-bg-white span { background-color: var(--transparent-white-bg); padding: 0.15em 0.5em; }

        #primary-subtitle-display { bottom: 60px; font-size: 26px; }
        #secondary-subtitle-display { top: 20px; font-size: 21px; direction: ltr; }
        
        #resume-playback-toast {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--glass-dark-bg-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border-color);
            border-radius: 16px;
            padding: 12px 20px;
            z-index: 12;
            display: none;
            align-items: center;
            gap: 15px;
            box-shadow: var(--neumorphic-shadow);
            opacity: 0;
            transition: opacity 0.3s ease, bottom 0.3s ease;
        }
        #resume-playback-toast.visible {
            display: flex;
            opacity: 1;
        }
        #resume-playback-toast p {
            margin: 0;
            font-size: 14px;
        }
        #resume-playback-toast button {
            background-color: var(--interactive-bg-color);
            color: var(--text-color);
            border: 1px solid var(--glass-border-color);
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 2px 2px 5px var(--neumorphic-shadow-dark), -2px -2px 5px var(--neumorphic-shadow-light);
        }
        #resume-playback-toast button:active:not(#close-resume-toast-btn) {
            box-shadow: var(--neumorphic-shadow-inset);
        }
        #close-resume-toast-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 24px;
            line-height: 1;
            padding: 5px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease;
            box-shadow: none;
        }
        #close-resume-toast-btn:hover {
            opacity: 1;
        }
        
        #drop-zone {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); border: 3px dashed var(--accent-color);
            display: flex; justify-content: center; align-items: center;
            text-align: center; font-size: 2rem; color: #fff; z-index: 10;
            transition: background-color 0.3s, border-color 0.3s, width 0.3s ease-in-out, margin-left 0.3s ease-in-out;
        }
        #drop-zone.hidden { display: none; }
        #drop-zone.dragover { background-color: rgba(0, 170, 255, 0.3); border-color: #fff; }

        #online-link-container {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--glass-dark-bg-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border-color);
            border-radius: 16px;
            padding: 10px;
            z-index: 11;
            display: flex;
            gap: 10px;
            width: 50%;
            max-width: 600px;
            box-shadow: var(--neumorphic-shadow);
        }

        #online-link-container.hidden {
            display: none;
        }

        #online-link-input {
            flex-grow: 1;
            background-color: transparent;
            color: var(--text-color);
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            font-family: inherit;
            font-size: 14px;
            direction: ltr;
            text-align: left;
            box-shadow: var(--neumorphic-shadow-inset);
        }

        #online-link-input::placeholder {
            color: var(--text-color);
            opacity: 0.7;
            text-align: right;
        }

        #play-online-link-btn {
            background-color: var(--accent-color);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-family: inherit;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 2px 2px 5px var(--neumorphic-shadow-dark), -2px -2px 5px var(--neumorphic-shadow-light);
        }

        #play-online-link-btn:hover {
            transform: scale(1.05);
        }
        #play-online-link-btn:active {
            box-shadow: var(--neumorphic-shadow-inset);
            transform: scale(1);
        }


        .controls-container {
            position: absolute; bottom: 0; left: 0; width: 100%; z-index: 5;
            opacity: 0; transition: opacity 0.3s ease-in-out, width 0.3s ease-in-out, margin-left 0.3s ease-in-out; background: none;
        }
        .player-container .controls-container.visible { opacity: 1; }

        .controls {
            position: absolute;
            bottom: 3.7px; /* Adjusted for scaling */
            left: 50%;
            /* -- MODIFIED: Using variable for scaling -- */
            transform: translateX(-50%) scale(var(--controls-scale));
            width: calc(100% - 40px);
            max-width: 1200px;
            padding: 4px 15px;
            display: flex;
            align-items: center;
            background-color: var(--glass-bg-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid var(--glass-border-color);
            box-shadow: var(--neumorphic-shadow);
            transform-origin: bottom center; /* Added for better scaling anchor */
        }

        .progress-bar { flex-grow: 1; height: 5px; background-color: var(--slider-track-color); border-radius: 3px; margin: 0 15px; cursor: pointer; direction: ltr; position: relative; box-shadow: var(--neumorphic-shadow-inset); }
        .progress-filled { height: 100%; background-color: var(--progress-filled-color); border-radius: 3px; width: 0%; pointer-events: none; position: relative; }
        .progress-filled::after { content: ''; position: absolute; right: 0; top: 50%; transform: translate(50%, -50%); width: 16px; height: 16px; background: var(--progress-filled-color); border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.2s ease; }
        .progress-bar:hover .progress-filled::after { opacity: 1; }

        .bottom-controls { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .left-controls, .right-controls { display: flex; align-items: center; gap: 15px; }
        #speed-display { font-size: 14px; text-shadow: 0 1px 2px rgba(0,0,0,0.7); min-width: 40px; text-align: center; }

        .control-button { 
            background: none; 
            border: none; 
            color: var(--text-color); 
            font-size: 24px; 
            cursor: pointer; 
            padding: 8px;
            display: flex; 
            align-items: center; 
            justify-content: center;
            border-radius: 50%;
            transition: transform 0.2s ease, box-shadow 0.2s ease; 
            box-shadow: 3px 3px 6px var(--neumorphic-shadow-dark), -3px -3px 6px var(--neumorphic-shadow-light);
        }
        .control-button:hover { 
            /* -- MODIFIED: Changed hover effect to scale -- */
            transform: scale(1.15); 
        }
        .control-button:active {
            /* -- MODIFIED: Adjusted active effect for scaling -- */
            box-shadow: var(--neumorphic-shadow-inset);
            transform: scale(1.05);
        }
        .control-button:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none; 
            box-shadow: none;
        }

        #time-display { cursor: pointer; user-select: none; direction: ltr; font-size: 14px; text-shadow: 0 1px 2px rgba(0,0,0,0.7); min-width: 90px; text-align: center; }
        .control-button svg { width: 24px; height: 24px; fill: var(--text-color); filter: drop-shadow(0 1px 2px rgba(0,0,0,0.5)); }
        #fullscreen-btn svg path { fill: none; stroke: var(--text-color); stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        #play-pause-btn { 
            width: 48px; height: 48px;
        }
        #play-pause-btn svg { width: 30px; height: 30px; }

        .volume-container { display: flex; align-items: center; direction: ltr; }
        .volume-container .control-button svg { width: 22px; height: 22px; }
        #volume-slider-container { width: 80px; height: 5px; background-color: var(--slider-track-color); border-radius: 3px; cursor: pointer; position: relative; box-shadow: var(--neumorphic-shadow-inset); }
        #volume-filled { height: 100%; background-color: var(--progress-filled-color); border-radius: 3px; width: 100%; pointer-events: none; position: relative; }
        #volume-filled::after { content: ''; position: absolute; right: 0; top: 50%; transform: translate(50%, -50%); width: 14px; height: 14px; background: var(--progress-filled-color); border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.2s ease; }
        .volume-container:hover #volume-filled::after { opacity: 1; }

        #settings-panel {
            position: absolute;
            bottom: 70px; 
            right: 20px;
            background-color: var(--glass-dark-bg-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px;
            z-index: 6;
            display: none;
            width: 315px;
            border: 1px solid var(--glass-border-color);
            font-size: 0.9em;
            box-shadow: var(--neumorphic-shadow);
            /* -- MODIFIED: Using variable for scaling -- */
            transform-origin: bottom right; /* Anchor scaling to the corner */
            transform: scale(var(--settings-scale));
        }

        #playlist-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--playlist-width);
            height: 100%;
            background-color: var(--glass-dark-bg-color);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            z-index: 7;
            padding: 20px;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            overflow-y: auto;
            direction: rtl;
            box-sizing: border-box;
            border-right: 1px solid var(--glass-border-color);
            box-shadow: var(--neumorphic-shadow);
        }
        #playlist-panel.visible { transform: translateX(0); }
        .playlist-item {
            padding: 10px; margin-bottom: 5px; border-radius: 8px;
            cursor: pointer; transition: background-color 0.2s ease, box-shadow 0.2s ease;
            font-size: 14px; color: var(--text-color);
            border: 1px solid transparent;
            text-align: right;
            white-space: normal;
            word-wrap: break-word;
        }
        .playlist-item:hover { background-color: var(--playlist-item-hover-bg); }
        .playlist-item.active { 
            background-color: var(--playlist-item-active-bg); 
            border-color: var(--accent-color); 
            font-weight: bold;
            box-shadow: var(--neumorphic-shadow-inset);
        }
        
        #playlist-resizer {
            position: fixed;
            top: 0;
            left: var(--playlist-width);
            width: 8px;
            height: 100%;
            cursor: col-resize;
            z-index: 8;
            display: none;
            margin-left: -4px;
        }
        #playlist-panel.visible + #playlist-resizer { display: block; }

        .player-container.playlist-active {
            width: calc(100vw - var(--playlist-width));
            margin-left: var(--playlist-width);
        }

        input[type="range"].subtitle-slider { -webkit-appearance: none; appearance: none; background: transparent; cursor: pointer; width: 100%; }
        input[type="range"].subtitle-slider::-webkit-slider-runnable-track { background: var(--slider-track-highlight-color); height: 4px; border-radius: 4px; box-shadow: var(--neumorphic-shadow-inset); }
        input[type="range"].subtitle-slider::-moz-range-track { background: var(--slider-track-highlight-color); height: 4px; border-radius: 4px; box-shadow: var(--neumorphic-shadow-inset); }
        input[type="range"].subtitle-slider::-webkit-slider-thumb { -webkit-appearance: none; margin-top: -5px; background-color: var(--progress-filled-color); height: 14px; width: 14px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.2); box-shadow: 2px 2px 4px var(--neumorphic-shadow-dark), -2px -2px 4px var(--neumorphic-shadow-light); }
        input[type="range"].subtitle-slider::-moz-range-thumb { border: none; background-color: var(--progress-filled-color); height: 14px; width: 14px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.2); box-shadow: 2px 2px 4px var(--neumorphic-shadow-dark), -2px -2px 4px var(--neumorphic-shadow-light); }

        .settings-section { margin-bottom: 15px; border-bottom: 1px solid var(--glass-border-color); padding-bottom: 12px; }
        .settings-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .settings-title { font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; }
        .settings-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .settings-row label { flex-basis: 40%; }
        .settings-row select, .settings-row .options-container, .settings-row input[type="range"], #add-subtitle-btn { flex-basis: 60%; }
        .settings-row select { background-color: var(--glass-bg-color); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); color: var(--text-color); border: 1px solid var(--glass-border-color); border-radius: 6px; padding: 4px; width: 100%; overflow: hidden; text-overflow: ellipsis; box-shadow: var(--neumorphic-shadow-inset); }
        .settings-row select option { background-color: var(--dropdown-option-bg); color: var(--text-color); }
        
        .color-options button { width: 18px; height: 18px; border-radius: 50%; border: 1px solid var(--text-color); cursor: pointer; margin: 0 2px; transition: transform 0.2s ease, box-shadow 0.2s ease; box-shadow: 2px 2px 4px var(--neumorphic-shadow-dark), -2px -2px 4px var(--neumorphic-shadow-light); }
        .color-options button:hover { transform: scale(1.15); }
        .color-options button:active { box-shadow: var(--neumorphic-shadow-inset); }

        .direction-buttons button, #add-subtitle-btn {
            background-color: var(--interactive-bg-color);
            color: var(--text-color);
            border: 1px solid var(--glass-border-color);
            border-radius: 5px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 2px 2px 4px var(--neumorphic-shadow-dark), -2px -2px 4px var(--neumorphic-shadow-light);
        }
        .direction-buttons button:hover:not(.active), #add-subtitle-btn:hover { background-color: rgba(255, 255, 255, 0.2); }
        .direction-buttons button.active { 
            background-color: var(--accent-color); 
            border-color: var(--accent-color); 
            color: #fff; 
            box-shadow: var(--neumorphic-shadow-inset);
        }
    </style>
</head>
<body>

<!-- HTML body remains the same as your original code -->
<div id="playlist-panel"></div>
<div id="playlist-resizer"></div>
<input type="file" id="subtitle-file-input" hidden multiple accept=".srt,.vtt,.ass">

<div class="player-container" id="player-container">
    <video id="video"></video>
    <div id="online-link-container">
        <input type="text" id="online-link-input" placeholder="آدرس ویدیوی آنلاین را وارد کنید">
        <button id="play-online-link-btn">پخش</button>
    </div>
    <div id="drop-zone"><p>فایل‌های ویدیو و زیرنویس را اینجا بکشید و رها کنید</p></div>
    <div class="subtitle-display" id="primary-subtitle-display"></div>
    <div class="subtitle-display" id="secondary-subtitle-display"></div>
    <div id="resume-playback-toast">
        <p>ادامه از آخرین زمان پخش...</p>
        <button id="start-over-btn">شروع از اول</button>
        <button id="close-resume-toast-btn">&times;</button>
    </div>
    <div class="controls-container" id="controls-container">
        <div class="controls">
            <div class="bottom-controls">
                <div class="left-controls">
                    <button class="control-button" id="fullscreen-btn"></button>
                    <button class="control-button" id="pip-btn">
                        <svg viewBox="0 0 24 24"><path d="M19 7h-8v6h8V7zm2-4H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H3V5h18v14z"/></svg>
                    </button>
                    <button class="control-button" id="settings-btn">
                         <svg viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69-.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22-.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
                    </button>
                    <div class="volume-container">
                        <button class="control-button" id="mute-btn"></button>
                        <div id="volume-slider-container">
                            <div id="volume-filled"></div>
                        </div>
                    </div>
                    <span id="time-display">00:00 / 00:00</span>
                </div>

                <div class="progress-bar" id="progress-bar"><div class="progress-filled" id="progress-filled"></div></div>

                <div class="right-controls">
                    <span id="speed-display">1.0x</span>
                    <button class="control-button" id="prev-btn">
                        <svg viewBox="0 0 24 24"><path d="M16 6h2v12h-2zm-4.5 6l-8.5 6V6z"/></svg>
                    </button>
                    <button class="control-button" id="play-pause-btn"></button>
                    <button class="control-button" id="next-btn">
                        <svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                    </button>
                    <button class="control-button" id="playlist-btn">
                        <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="settings-panel">
     <div class="settings-section">
        <div class="settings-title"><span>تنظیمات عمومی</span></div>
        <div class="settings-row">
            <label>تم برنامه:</label>
            <div class="options-container direction-buttons" id="theme-selector">
                <button data-value="dark" class="active">تاریک</button>
                <button data-value="light">روشن</button>
            </div>
        </div>
        <div class="settings-row">
            <label>وارونگی رنگ ویدیو:</label>
            <div class="options-container direction-buttons" id="invert-colors-selector">
                <button data-value="off" class="active">عادی</button>
                <button data-value="on">وارونه</button>
            </div>
        </div>
        <div class="settings-row">
            <label>افزودن زیرنویس:</label>
            <button id="add-subtitle-btn">انتخاب فایل</button>
        </div>
    </div>
    <div class="settings-section">
        <div class="settings-title"><span>زیرنویس اصلی</span></div>
        <div class="settings-row">
            <label for="primary-sub-select">انتخاب زیرنویس:</label>
            <select id="primary-sub-select"></select>
        </div>
        <div class="settings-row">
            <label for="primary-fontsize-slider">اندازه فونت:</label>
            <input type="range" class="subtitle-slider" data-target="primary" id="primary-fontsize-slider" min="14" max="60" value="26">
        </div>
        <div class="settings-row">
            <label>جهت متن:</label>
            <div class="options-container direction-buttons" data-target="primary">
                <button data-value="rtl" class="active">فارسی (RTL)</button>
                <button data-value="ltr">English (LTR)</button>
            </div>
        </div>
        <div class="settings-row">
            <label>رنگ متن:</label>
            <div class="options-container color-options" data-target="primary" data-prop="color">
                <button style="background-color: #FFFFFF;" data-value="#FFFFFF"></button>
                <button style="background-color: #ffc107;" data-value="#ffc107"></button>
                <button style="background-color: #4dabf7;" data-value="#4dabf7"></button>
                <button style="background-color: #00ff9d;" data-value="#00ff9d"></button>
                <button style="background-color: red;" data-value="red"></button>
                <button style="background-color: black; border-color: #555;" data-value="black"></button>
            </div>
        </div>
        <div class="settings-row">
            <label>رنگ پس‌زمینه:</label>
            <div class="options-container color-options" data-target="primary" data-prop="background">
                <button style="background-color: black;" data-value="var(--transparent-black-bg)"></button>
                <button style="background-color: white;" data-value="var(--transparent-white-bg)"></button>
                <button data-value="transparent" style="background:none; border-color:grey;">-</button>
            </div>
        </div>
    </div>
    <div class="settings-section">
        <div class="settings-title">
            <span>زیرنویس دوم</span>
            <input type="checkbox" id="secondary-sub-toggle">
        </div>
        <div id="secondary-sub-settings" style="display:none;">
            <div class="settings-row">
                <label for="secondary-sub-select">انتخاب زیرنویس:</label>
                <select id="secondary-sub-select"></select>
            </div>
            <div class="settings-row">
                <label for="secondary-fontsize-slider">اندازه فونت:</label>
                <input type="range" class="subtitle-slider" data-target="secondary" id="secondary-fontsize-slider" min="14" max="60" value="21">
            </div>
            <div class="settings-row">
                <label>جهت متن:</label>
                <div class="options-container direction-buttons" data-target="secondary">
                    <button data-value="rtl">فارسی (RTL)</button>
                    <button data-value="ltr" class="active">English (LTR)</button>
                </div>
            </div>
            <div class="settings-row">
                <label>رنگ متن:</label>
                <div class="options-container color-options" data-target="secondary" data-prop="color">
                    <button style="background-color: #FFFFFF;" data-value="#FFFFFF"></button>
                    <button style="background-color: #ffc107;" data-value="#ffc107"></button>
                    <button style="background-color: #4dabf7;" data-value="#4dabf7"></button>
                    <button style="background-color: #00ff9d;" data-value="#00ff9d"></button>
                    <button style="background-color: red;" data-value="red"></button>
                    <button style="background-color: black; border-color: #555;" data-value="black"></button>
                </div>
            </div>
            <div class="settings-row">
                <label>رنگ پس‌زمینه:</label>
                <div class="options-container color-options" data-target="secondary" data-prop="background">
                    <button style="background-color: black;" data-value="var(--transparent-black-bg)"></button>
                    <button style="background-color: white;" data-value="var(--transparent-white-bg)"></button>
                    <button data-value="transparent" style="background:none; border-color:grey;">-</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const getElem = id => document.getElementById(id);
    const playerContainer = getElem('player-container');
    const video = getElem('video');
    const dropZone = getElem('drop-zone');
    const playPauseBtn = getElem('play-pause-btn');
    const muteBtn = getElem('mute-btn');
    const progressBar = getElem('progress-bar');
    const progressFilled = getElem('progress-filled');
    const timeDisplay = getElem('time-display');
    const speedDisplay = getElem('speed-display');
    const settingsBtn = getElem('settings-btn');
    const settingsPanel = getElem('settings-panel');
    const pipBtn = getElem('pip-btn');
    const fullscreenBtn = getElem('fullscreen-btn');
    const controlsContainer = getElem('controls-container');
    const primarySubDisplay = getElem('primary-subtitle-display');
    const secondarySubDisplay = getElem('secondary-subtitle-display');
    const primarySubSelect = getElem('primary-sub-select');
    const secondarySubSelect = getElem('secondary-sub-select');
    const primaryFontsizeSlider = getElem('primary-fontsize-slider');
    const secondaryFontsizeSlider = getElem('secondary-fontsize-slider');
    const secondarySubToggle = getElem('secondary-sub-toggle');
    const secondarySubSettings = getElem('secondary-sub-settings');
    const volumeSliderContainer = getElem('volume-slider-container');
    const volumeFilled = getElem('volume-filled');
    const playlistBtn = getElem('playlist-btn');
    const playlistPanel = getElem('playlist-panel');
    const playlistResizer = getElem('playlist-resizer'); 
    const nextBtn = getElem('next-btn');
    const prevBtn = getElem('prev-btn');
    const themeSelector = getElem('theme-selector');
    const onlineLinkContainer = getElem('online-link-container');
    const onlineLinkInput = getElem('online-link-input');
    const playOnlineLinkBtn = getElem('play-online-link-btn');
    const addSubtitleBtn = getElem('add-subtitle-btn');
    const subtitleFileInput = getElem('subtitle-file-input');
    const resumeToast = getElem('resume-playback-toast');
    const startOverBtn = getElem('start-over-btn');
    const closeResumeToastBtn = getElem('close-resume-toast-btn');
    const invertColorsSelector = getElem('invert-colors-selector');

    let loadedVideos = [], loadedSubtitles = [], currentVideoIndex = -1, activePrimaryCues = [], activeSecondaryCues = [], previousPlaybackRate = 1.0, isSecondarySubEnabled = false, controlsTimeout, displayRemainingTime = false, isSeeking = false, isVolumeSeeking = false;
    let timeUpdateInterval;
    const persianSubKeywords = ['persian', 'per', 'fa', 'farsi', 'فارسی'];
    const englishSubKeywords = ['english', 'en', 'انگلیسی'];
    let primarySubPosition = { x: 0, y: 0 }, secondarySubPosition = { x: 0, y: 0 };
    const pressedKeys = new Set();

    const playIconSVG = `<svg viewBox="0 0 24 24"><path d="M8,5.14V19.14L19,12.14L8,5.14Z"/></svg>`;
    const pauseIconSVG = `<svg viewBox="0 0 24 24"><path d="M14,19H18V5H14M6,19H10V5H6V19Z"/></svg>`;
    const fullscreenEnterIcon = `<svg viewBox="0 0 24 24"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>`;
    const fullscreenExitIcon = `<svg viewBox="0 0 24 24"><path d="M5 8V5a2 2 0 0 1 2-2h3m11 5V5a2 2 0 0 0-2-2h-3M8 19H5a2 2 0 0 1-2-2v-3m14 0v3a2 2 0 0 1-2 2h-3"/></svg>`;
    const volumeIcon = `<svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>`;
    const muteIcon = `<svg viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>`;

    const srtToVtt = srtText => `WEBVTT\n\n${srtText.replace(/(\d{2}:\d{2}:\d{2}),(\d{3})/g, '$1.$2').replace(/^\d+\s*$/gm, '')}`;
    const assToVtt = assText => {
        const dialogueLines = assText.split('\n').filter(line => line.startsWith('Dialogue:'));
        const vttContent = dialogueLines.map(line => {
            const parts = line.split(',');
            const start = `0${parts[1]}`.replace(/(\d{2}):(\d{2}):(\d{2})\.(\d{2})/, '$1:$2:$3.$40');
            const end = `0${parts[2]}`.replace(/(\d{2}):(\d{2}):(\d{2})\.(\d{2})/, '$1:$2:$3.$40');
            const text = parts.slice(9).join(',').replace(/{[^}]+}/g, '').trim();
            return text ? `${start} --> ${end}\n${text}` : '';
        }).filter(Boolean).join('\n\n');
        return `WEBVTT\n\n${vttContent}`;
    };
    const parseVttCues = vttText => {
        const cues = [], lines = vttText.split('\n');
        for (let i = 0; i < lines.length; i++) {
            if (lines[i].includes('-->')) {
                const [startStr, endStr] = lines[i].split(' --> '), textLines = [];
                while (lines[++i] && lines[i].trim()) textLines.push(lines[i]);
                cues.push({ start: timeStrToSeconds(startStr), end: timeStrToSeconds(endStr), text: textLines.join(' ') });
            }
        }
        return cues;
    };
    const timeStrToSeconds = (timeStr = '0:0') => timeStr.trim().split(':').reduce((acc, part, i, arr) => acc + parseFloat(part) * Math.pow(60, arr.length - 1 - i), 0);
    const formatTime = timeInSeconds => {
        const absTime = Math.abs(timeInSeconds), h = Math.floor(absTime / 3600), m = Math.floor((absTime % 3600) / 60), s = Math.floor(absTime % 60);
        return `${h > 0 ? String(h).padStart(2, '0') + ':' : ''}${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    };
    
    const saveSettings = () => {
        const root = document.documentElement;
        const settings = {
            theme: document.body.classList.contains('light-theme') ? 'light' : 'dark',
            videoInverted: video.classList.contains('inverted'),
            volume: video.volume,
            muted: video.muted,
            playbackRate: video.playbackRate,
            displayRemainingTime,
            controlsScale: getComputedStyle(root).getPropertyValue('--controls-scale').trim(),
            settingsScale: getComputedStyle(root).getPropertyValue('--settings-scale').trim(),
            primary: {
                fontSize: primarySubDisplay.style.fontSize,
                direction: primarySubDisplay.style.direction,
                color: primarySubDisplay.style.color,
                background: primarySubDisplay.className.match(/has-bg-\w+/)?.[0] || 'transparent'
            },
            secondary: {
                enabled: isSecondarySubEnabled,
                fontSize: secondarySubDisplay.style.fontSize,
                direction: secondarySubDisplay.style.direction,
                color: secondarySubDisplay.style.color,
                background: secondarySubDisplay.className.match(/has-bg-\w+/)?.[0] || 'transparent'
            }
        };
        localStorage.setItem('videoPlayerSettings', JSON.stringify(settings));
    };

    const loadSettings = () => {
        const settings = JSON.parse(localStorage.getItem('videoPlayerSettings'));
        if (!settings) return;

        const root = document.documentElement;
        root.style.setProperty('--controls-scale', settings.controlsScale || '0.96');
        root.style.setProperty('--settings-scale', settings.settingsScale || '0.97');

        document.body.classList.toggle('light-theme', settings.theme === 'light');
        themeSelector.querySelector(`button[data-value="dark"]`).classList.toggle('active', settings.theme !== 'light');
        themeSelector.querySelector(`button[data-value="light"]`).classList.toggle('active', settings.theme === 'light');
        
        video.classList.toggle('inverted', settings.videoInverted);
        if (settings.videoInverted) {
            invertColorsSelector.querySelector(`button[data-value="off"]`).classList.remove('active');
            invertColorsSelector.querySelector(`button[data-value="on"]`).classList.add('active');
        }

        video.volume = settings.volume || 1;
        video.muted = settings.muted || false;
        video.playbackRate = settings.playbackRate || 1.0;
        speedDisplay.textContent = `${video.playbackRate.toFixed(1)}x`;
        displayRemainingTime = settings.displayRemainingTime || false;
        
        if (settings.primary) {
            primaryFontsizeSlider.value = parseInt(settings.primary.fontSize, 10) || 26;
            primarySubDisplay.style.fontSize = settings.primary.fontSize || '26px';
            primarySubDisplay.style.direction = settings.primary.direction || 'rtl';
            primarySubDisplay.style.color = settings.primary.color || 'white';
            primarySubDisplay.classList.remove('has-bg-black', 'has-bg-white');
            if (settings.primary.background && settings.primary.background !== 'transparent') {
                primarySubDisplay.classList.add(settings.primary.background);
            }
        }
        
        if (settings.secondary) {
            secondarySubToggle.checked = settings.secondary.enabled;
            isSecondarySubEnabled = settings.secondary.enabled;
            secondarySubSettings.style.display = isSecondarySubEnabled ? 'block' : 'none';
            secondaryFontsizeSlider.value = parseInt(settings.secondary.fontSize, 10) || 21;
            secondarySubDisplay.style.fontSize = settings.secondary.fontSize || '21px';
            secondarySubDisplay.style.direction = settings.secondary.direction || 'ltr';
            secondarySubDisplay.style.color = settings.secondary.color || 'white';
            secondarySubDisplay.classList.remove('has-bg-black', 'has-bg-white');
            if (settings.secondary.background && settings.secondary.background !== 'transparent') {
                secondarySubDisplay.classList.add(settings.secondary.background);
            }
        }
    };
    
    // -- MODIFIED START: Unified function to get video ID (URL for online, name for offline)
    const getCurrentVideoId = () => {
        // Online videos are identified by their full URL
        if (video.src && !video.src.startsWith('blob:')) {
            return video.src;
        }
        // Offline videos are identified by their file name
        if (currentVideoIndex >= 0 && loadedVideos[currentVideoIndex]) {
            return loadedVideos[currentVideoIndex].name;
        }
        return null;
    };
    // -- MODIFIED END

    // -- MODIFIED START: Uses unified ID for saving playback position
    const savePlaybackPosition = () => {
        const videoId = getCurrentVideoId();
        if (!videoId) return;

        if (video.duration && video.currentTime > video.duration - 5) {
             localStorage.removeItem(videoId);
        } else {
             localStorage.setItem(videoId, video.currentTime);
        }
    };
    // -- MODIFIED END

    // -- MODIFIED START: Uses unified ID to check for saved position
    const checkForSavedPosition = () => {
        const videoId = getCurrentVideoId();
        if (!videoId) return;
        
        const savedTime = parseFloat(localStorage.getItem(videoId));

        if (savedTime && savedTime > 5) {
            video.addEventListener('seeked', () => {
                updateSubtitles(video.currentTime);
            }, { once: true });
            
            video.currentTime = savedTime;

            const hideToast = () => {
                resumeToast.classList.remove('visible');
                startOverBtn.removeEventListener('click', startOverHandler);
                closeResumeToastBtn.removeEventListener('click', hideToast);
            };

            const startOverHandler = () => {
                localStorage.removeItem(videoId);
                video.currentTime = 0;
                hideToast();
            };

            startOverBtn.addEventListener('click', startOverHandler);
            closeResumeToastBtn.addEventListener('click', hideToast);
            
            resumeToast.classList.add('visible');
            setTimeout(hideToast, 8000);
        }
    };
    // -- MODIFIED END
    
    const updateSubtitles = currentTime => {
        const findCue = cues => cues.find(cue => currentTime >= cue.start && currentTime <= cue.end);
        primarySubDisplay.innerHTML = (findCue(activePrimaryCues) || {text: ''}).text ? `<span>${findCue(activePrimaryCues).text}</span>` : '';
        secondarySubDisplay.innerHTML = '';
        if (isSecondarySubEnabled) secondarySubDisplay.innerHTML = (findCue(activeSecondaryCues) || {text: ''}).text ? `<span>${findCue(activeSecondaryCues).text}</span>` : '';
    };
    
    const updateTimeDisplay = () => {
        const duration = video.duration || 0, currentTime = video.currentTime || 0;
        const timeToShow = displayRemainingTime ? duration - currentTime : currentTime, prefix = displayRemainingTime ? '-' : '';
        timeDisplay.textContent = `${prefix}${formatTime(timeToShow)} / ${formatTime(duration)}`;
    };

    const startControlsHideTimer = () => {
        clearTimeout(controlsTimeout);
        controlsTimeout = setTimeout(() => {
            const isFocusedOnSettings = settingsPanel.contains(document.activeElement) || document.activeElement === settingsBtn;
            const isHovering = controlsContainer.matches(':hover') || settingsPanel.matches(':hover') || resumeToast.matches(':hover');
            if (!video.paused && !isSeeking && !isVolumeSeeking && !isHovering && !isFocusedOnSettings) {
                controlsContainer.classList.remove('visible');
                playerContainer.style.cursor = 'none';
            }
        }, 2100);
    };
    
    const handleFileDrop = async files => {
        dropZone.classList.remove('dragover');
        if (files.length === 0) return;

        const videoFiles = [], subtitleFiles = [];
        Array.from(files).forEach(file => {
            if (file.type.startsWith('video/')) videoFiles.push(file);
            else if (/\.(srt|vtt|ass)$/i.test(file.name)) subtitleFiles.push(file);
        });

        if (videoFiles.length > 0) {
            loadedVideos = videoFiles.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true }));
            dropZone.classList.add('hidden');
            onlineLinkContainer.classList.add('hidden');
            populatePlaylistUI();
        }

        loadedSubtitles = await Promise.all(subtitleFiles.map(file => new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = event => {
                let vttContent = file.name.endsWith('.srt') ? srtToVtt(event.target.result) : file.name.endsWith('.ass') ? assToVtt(event.target.result) : event.target.result;
                resolve({ name: file.name, vtt: vttContent, cues: parseVttCues(vttContent) });
            };
            reader.readAsText(file);
        })));
        updateSubtitleSelectors();
        if (currentVideoIndex === -1 && loadedVideos.length > 0) loadVideo(0); 
    };

    const loadVideo = index => {
        if (index < 0 || index >= loadedVideos.length) return;
        currentVideoIndex = index;
        if (video.src.startsWith('blob:')) URL.revokeObjectURL(video.src);
        video.src = URL.createObjectURL(loadedVideos[index]);
        video.load();
        video.play().catch(e => console.error("Playback failed:", e));
        updatePlaylistHighlight();
        updateNavButtons();
        autoSelectSubtitlesForCurrentVideo();
        // -- MODIFIED: The check for saved position is now handled by a global 'loadedmetadata' event listener
    };

    const autoSelectSubtitlesForCurrentVideo = () => {
        if (currentVideoIndex < 0 || loadedSubtitles.length === 0) return;

        if (loadedVideos.length === 1) {
            const findSubIndexByKeywords = (keywords) => loadedSubtitles.findIndex(sub => keywords.some(kw => sub.name.toLowerCase().includes(kw)));
            
            const persianIndex = findSubIndexByKeywords(persianSubKeywords);
            const englishIndex = findSubIndexByKeywords(englishSubKeywords);

            if (persianIndex > -1) {
                primarySubSelect.value = persianIndex;
                primarySubSelect.dispatchEvent(new Event('change'));
            }

            if (englishIndex > -1) {
                secondarySubToggle.checked = true;
                secondarySubToggle.dispatchEvent(new Event('change'));
                secondarySubSelect.value = englishIndex;
                secondarySubSelect.dispatchEvent(new Event('change'));
            }
        } else {
            const videoBaseName = loadedVideos[currentVideoIndex].name.substring(0, loadedVideos[currentVideoIndex].name.lastIndexOf('.'));
            const findSubIndex = isPersian => loadedSubtitles.findIndex(sub => persianSubKeywords.some(kw => sub.name.toLowerCase().includes(kw)) === isPersian && sub.name.toLowerCase().startsWith(videoBaseName.toLowerCase()));
            
            primarySubSelect.value = findSubIndex(true);
            primarySubSelect.dispatchEvent(new Event('change'));
            
            if (isSecondarySubEnabled) {
                secondarySubSelect.value = findSubIndex(false);
                secondarySubSelect.dispatchEvent(new Event('change'));
            }
        }
    };
    
    const populatePlaylistUI = () => {
        playlistPanel.innerHTML = '';
        loadedVideos.forEach((file, index) => {
            const item = document.createElement('div');
            item.className = 'playlist-item';
            item.textContent = file.name;
            item.dataset.index = index;
            item.addEventListener('click', () => loadVideo(index));
            playlistPanel.appendChild(item);
        });
    };
    
    const updatePlaylistHighlight = () => document.querySelectorAll('.playlist-item').forEach(item => item.classList.toggle('active', parseInt(item.dataset.index, 10) === currentVideoIndex));

    const updateNavButtons = () => {
        const hasMultiple = loadedVideos.length > 1, style = hasMultiple ? 'flex' : 'none';
        prevBtn.style.display = nextBtn.style.display = playlistBtn.style.display = style;
        prevBtn.disabled = !hasMultiple || currentVideoIndex === loadedVideos.length - 1;
        nextBtn.disabled = !hasMultiple || currentVideoIndex === 0;
    };
    
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', e => { e.preventDefault(); dropZone.classList.remove('dragover'); });
    dropZone.addEventListener('drop', e => { e.preventDefault(); handleFileDrop(e.dataTransfer.files); });

    playOnlineLinkBtn.addEventListener('click', () => {
        const videoUrl = onlineLinkInput.value.trim();
        if (videoUrl) {
            try {
                new URL(videoUrl);
                loadedVideos = []; 
                currentVideoIndex = -1;
                populatePlaylistUI();
                updateNavButtons();
                loadedSubtitles = []; 
                updateSubtitleSelectors();

                video.src = videoUrl;
                video.load();
                video.play().catch(e => console.error("Online video playback failed:", e));
                
                onlineLinkContainer.classList.add('hidden');
                dropZone.classList.add('hidden');
            } catch (error) {
                alert('لطفا یک آدرس اینترنتی معتبر وارد کنید.');
                console.error("Invalid URL:", error);
            }
        }
    });

    video.addEventListener('play', () => { 
        playPauseBtn.innerHTML = pauseIconSVG; 
        startControlsHideTimer(); 
        clearInterval(timeUpdateInterval);
        timeUpdateInterval = setInterval(savePlaybackPosition, 1000);
    });
    video.addEventListener('pause', () => { 
        playPauseBtn.innerHTML = playIconSVG; 
        controlsContainer.classList.add('visible'); 
        playerContainer.style.cursor = 'default'; 
        clearTimeout(controlsTimeout);
        savePlaybackPosition();
        clearInterval(timeUpdateInterval);
    });
    video.addEventListener('ended', () => {
        savePlaybackPosition(); // This will clear the saved time
        if (!nextBtn.disabled) nextBtn.click();
    });
    video.addEventListener('timeupdate', () => {
        if (!isSeeking && video.duration) progressFilled.style.width = `${(video.currentTime / video.duration) * 100}%`;
        updateTimeDisplay();
        updateSubtitles(video.currentTime);
    });
    // -- MODIFIED START: Centralized 'loadedmetadata' handler for both online and offline videos
    video.addEventListener('loadedmetadata', () => {
        updateTimeDisplay();
        checkForSavedPosition();
    });
    // -- MODIFIED END
    video.addEventListener('volumechange', () => {
        const volumePercent = video.muted ? 0 : video.volume * 100;
        volumeFilled.style.width = `${volumePercent}%`;
        muteBtn.innerHTML = (video.muted || video.volume === 0) ? muteIcon : volumeIcon;
        saveSettings();
    });
    video.addEventListener('ratechange', saveSettings);

    playPauseBtn.addEventListener('click', () => video.paused ? video.play() : video.pause());
    nextBtn.addEventListener('click', () => loadVideo(currentVideoIndex - 1));
    prevBtn.addEventListener('click', () => loadVideo(currentVideoIndex + 1));
    playlistBtn.addEventListener('click', e => {
        e.stopPropagation();
        const isVisible = playlistPanel.classList.toggle('visible');
        playerContainer.classList.toggle('playlist-active', isVisible);
    });
    
    muteBtn.addEventListener('click', () => { video.muted = !video.muted; saveSettings(); });
    
    const handleScrub = (e, barEl, callback) => {
        const rect = barEl.getBoundingClientRect(), percentage = Math.max(0, Math.min((e.clientX - rect.left) / rect.width, 1));
        callback(percentage);
    };

    const addScrubListener = (barEl, onScrub, onStart, onEnd) => {
        barEl.addEventListener('mousedown', e => {
            onStart();
            const scrubMove = moveEvent => handleScrub(moveEvent, barEl, onScrub);
            const scrubEnd = () => {
                document.removeEventListener('mousemove', scrubMove);
                document.removeEventListener('mouseup', scrubEnd);
                onEnd();
            };
            document.addEventListener('mousemove', scrubMove);
            document.addEventListener('mouseup', scrubEnd);
            handleScrub(e, barEl, onScrub);
        });
    };

    addScrubListener(progressBar, p => { if(video.duration) { progressFilled.style.width = `${p * 100}%`; video.currentTime = p * video.duration; updateSubtitles(video.currentTime); } }, () => isSeeking = true, () => { isSeeking = false; savePlaybackPosition(); });
    addScrubListener(volumeSliderContainer, p => { video.muted = false; video.volume = p; }, () => isVolumeSeeking = true, () => { isVolumeSeeking = false; saveSettings(); });

    timeDisplay.addEventListener('click', () => { displayRemainingTime = !displayRemainingTime; updateTimeDisplay(); saveSettings(); });
    settingsBtn.addEventListener('click', e => { e.stopPropagation(); settingsPanel.style.display = settingsPanel.style.display === 'block' ? 'none' : 'block'; });
    pipBtn.addEventListener('click', () => document.pictureInPictureElement ? document.exitPictureInPicture() : (document.pictureInPictureEnabled && video.requestPictureInPicture()));
    fullscreenBtn.addEventListener('click', () => document.fullscreenElement ? document.exitFullscreen() : document.body.requestFullscreen().catch(err => console.error(err)));
    document.addEventListener('fullscreenchange', () => fullscreenBtn.innerHTML = document.fullscreenElement ? fullscreenExitIcon : fullscreenEnterIcon);
    
    playerContainer.addEventListener('mousemove', () => {
        controlsContainer.classList.add('visible');
        playerContainer.style.cursor = 'default';
        startControlsHideTimer();
    });

    playerContainer.addEventListener('mouseleave', () => { if (!video.paused) controlsContainer.classList.remove('visible'); });
    playerContainer.addEventListener('wheel', e => {
        e.preventDefault();
        video.muted = false;
        video.volume = Math.max(0, Math.min(1, video.volume - (e.deltaY > 0 ? 0.05 : -0.05)));
    });

    const adjustFontSize = (slider, increase) => {
        const change = increase ? 1 : -1;
        slider.value = Math.max(parseInt(slider.min, 10), Math.min(parseInt(slider.max, 10), parseInt(slider.value, 10) + change));
        slider.dispatchEvent(new Event('input', { bubbles: true }));
    };

    const handlePanelScale = (e, keyPlus, keyMinus, cssVar) => {
        if (e.key === keyPlus || e.key === keyMinus) {
            e.preventDefault();
            const root = document.documentElement;
            const currentScale = parseFloat(getComputedStyle(root).getPropertyValue(cssVar));
            const step = 0.02;
            let newScale = e.key === keyPlus ? currentScale + step : currentScale - step;
            newScale = Math.max(0.7, Math.min(1.4, newScale)); // Clamp scale between 70% and 140%
            root.style.setProperty(cssVar, newScale.toFixed(2));
            saveSettings();
        }
    };

    document.addEventListener('keyup', e => pressedKeys.delete(e.key.toLowerCase()));
    document.addEventListener('keydown', e => {
        if (['INPUT', 'SELECT'].includes(e.target.tagName)) return;
        const key = e.key.toLowerCase();
        pressedKeys.add(key);

        // Shortcuts for dynamic panel scaling
        if (e.ctrlKey && e.altKey) {
            handlePanelScale(e, '+', '-', '--controls-scale');
            return;
        }
        if (e.ctrlKey && e.shiftKey && (key === '+' || e.key === '-')) {
            handlePanelScale(e, '+', '-', '--settings-scale');
            return;
        }

        const resetSubtitleCombination = (pressedKeys.has('[') && pressedKeys.has(']')) || (pressedKeys.has('ج') && pressedKeys.has('چ'));
        if (resetSubtitleCombination) {
            e.preventDefault();
            primarySubPosition = { x: 0, y: 0 };
            primarySubDisplay.style.transform = `translateX(calc(-50% + 0px)) translateY(0px)`;
            primaryFontsizeSlider.value = 26;
            primarySubDisplay.style.fontSize = `26px`;
            secondarySubPosition = { x: 0, y: 0 };
            secondarySubDisplay.style.transform = `translateX(calc(-50% + 0px)) translateY(0px)`;
            secondaryFontsizeSlider.value = 21;
            secondarySubDisplay.style.fontSize = `21px`;
            saveSettings();
            return;
        }

        // MODIFIED: Shortcut to reset panel sizes using a key combination
        const resetPanelsCombination = (pressedKeys.has(',') && pressedKeys.has('.')) || (pressedKeys.has('و') && pressedKeys.has('.'));
        if (resetPanelsCombination) {
            e.preventDefault();
            const root = document.documentElement;
            root.style.setProperty('--controls-scale', '0.96');
            root.style.setProperty('--settings-scale', '0.97');
            saveSettings();
            return;
        }


        // Subtitle positioning logic
        if (e.ctrlKey) {
            if (['arrowup', 'arrowdown', 'arrowleft', 'arrowright'].includes(key)) {
                e.preventDefault();
                const isShift = e.shiftKey;
                const positionTarget = isShift ? secondarySubPosition : primarySubPosition;
                const elementTarget = isShift ? secondarySubDisplay : primarySubDisplay;
                const step = 2;
                switch (key) {
                    case 'arrowup': positionTarget.y -= step; break;
                    case 'arrowdown': positionTarget.y += step; break;
                    case 'arrowleft': positionTarget.x -= step; break;
                    case 'arrowright': positionTarget.x += step; break;
                }
                elementTarget.style.transform = `translateX(calc(-50% + ${positionTarget.x}px)) translateY(${positionTarget.y}px)`;
                return;
            }
        }
        
        const prevent = [' ', 'arrowup', 'arrowdown', 'arrowleft', 'arrowright', '-', '='];
        if(prevent.includes(key) || key === '+') e.preventDefault();
        
        switch (key) {
            case ' ': video.paused ? video.play() : video.pause(); break;
            case 'arrowright': video.currentTime += 5; break;
            case 'arrowleft': video.currentTime -= 5; break;
            case 'arrowup': video.volume = Math.min(1, video.volume + 0.1); break;
            case 'arrowdown': video.volume = Math.max(0, video.volume - 0.1); break;
            case 'n': if(!nextBtn.disabled) nextBtn.click(); break;
            case 'b': if(!prevBtn.disabled) prevBtn.click(); break;
            case 'f':
            case 'ب':
                fullscreenBtn.click();
                break;
            case 'p': pipBtn.click(); break;
            case 'c': case 'ز': video.playbackRate = Math.min(4, video.playbackRate + 0.1); break;
            case 'x': case 'ط': video.playbackRate = Math.max(0.1, video.playbackRate - 0.1); break;
            case 'z': case 'ظ':
                video.playbackRate = (video.playbackRate === 1.0) ? (previousPlaybackRate || 1.0) : (previousPlaybackRate = video.playbackRate, 1.0);
                break;
            case '=': case '+': adjustFontSize(e.shiftKey ? secondaryFontsizeSlider : primaryFontsizeSlider, true); break;
            case '-': adjustFontSize(e.shiftKey ? secondaryFontsizeSlider : primaryFontsizeSlider, false); break;
        }
        speedDisplay.textContent = `${video.playbackRate.toFixed(1)}x`;
    });
    
    const minPlaylistWidth = 200, maxPlaylistWidth = 800;
    const startResize = e => { e.preventDefault(); document.body.style.cursor = 'col-resize'; playerContainer.style.pointerEvents = 'none'; document.addEventListener('mousemove', doResize); document.addEventListener('mouseup', stopResize); };
    const doResize = e => { let newWidth = e.clientX; if (newWidth > minPlaylistWidth && newWidth < maxPlaylistWidth) document.documentElement.style.setProperty('--playlist-width', `${newWidth}px`); };
    const stopResize = () => { document.body.style.cursor = 'default'; playerContainer.style.pointerEvents = 'auto'; document.removeEventListener('mousemove', doResize); document.removeEventListener('mouseup', stopResize); };
    playlistResizer.addEventListener('mousedown', startResize);

    const updateSubtitleSelectors = () => {
        const options = loadedSubtitles.map((sub, index) => `<option value="${index}">${sub.name}</option>`).join('');
        primarySubSelect.innerHTML = secondarySubSelect.innerHTML = `<option value="-1">غیرفعال</option>${options}`;
    };
    
    primarySubSelect.addEventListener('change', e => activePrimaryCues = loadedSubtitles[e.target.value]?.cues || []);
    secondarySubSelect.addEventListener('change', e => activeSecondaryCues = loadedSubtitles[e.target.value]?.cues || []);
    secondarySubToggle.addEventListener('change', e => {
        isSecondarySubEnabled = e.target.checked;
        secondarySubSettings.style.display = isSecondarySubEnabled ? 'block' : 'none';
        if (isSecondarySubEnabled) {
            if (secondarySubSelect.value === "-1" && currentVideoIndex >= 0 && loadedSubtitles.length > 0) {
                const videoBaseName = loadedVideos[currentVideoIndex].name.substring(0, loadedVideos[currentVideoIndex].name.lastIndexOf('.'));
                const findNonPersianSubIndex = () => loadedSubtitles.findIndex(sub => !persianSubKeywords.some(kw => sub.name.toLowerCase().includes(kw)) && sub.name.toLowerCase().startsWith(videoBaseName.toLowerCase()));
                const secondaryIndex = findNonPersianSubIndex();
                if (secondaryIndex > -1) {
                    secondarySubSelect.value = secondaryIndex;
                    secondarySubSelect.dispatchEvent(new Event('change'));
                }
            }
        } else {
            secondarySubDisplay.innerHTML = '';
            activeSecondaryCues = [];
            secondarySubSelect.value = "-1";
        }
        saveSettings();
    });
    
    settingsPanel.addEventListener('input', e => {
        if (e.target.classList.contains('subtitle-slider')) {
            const displayEl = e.target.dataset.target === 'primary' ? primarySubDisplay : secondarySubDisplay;
            displayEl.style.fontSize = `${e.target.value}px`;
            saveSettings();
        }
    });
    
    settingsPanel.addEventListener('click', e => {
        const button = e.target.closest('button');
        if(!button) return;

        if (button.parentElement.id === 'invert-colors-selector') {
            const mode = button.dataset.value;
            video.classList.toggle('inverted', mode === 'on');
            invertColorsSelector.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            saveSettings();
            return;
        }

        if (button.parentElement.id === 'theme-selector') {
            const theme = button.dataset.value;
            document.body.classList.toggle('light-theme', theme === 'light');
            themeSelector.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            saveSettings();
            return;
        }

        const container = button.parentElement, { target, prop, value } = { ...container.dataset, ...button.dataset };
        if (!target) return;
        const displayEl = target === 'primary' ? primarySubDisplay : secondarySubDisplay;
        
        if(prop === 'color') displayEl.style.color = value;
        else if (prop === 'background') {
            displayEl.classList.remove('has-bg-black', 'has-bg-white');
            if (value === 'var(--transparent-black-bg)') displayEl.classList.add('has-bg-black');
            else if (value === 'var(--transparent-white-bg)') displayEl.classList.add('has-bg-white');
        } else if (container.classList.contains('direction-buttons')) {
            displayEl.style.direction = value;
            container.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
        }
        saveSettings();
    });

    addSubtitleBtn.addEventListener('click', () => subtitleFileInput.click());
    subtitleFileInput.addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        const newFiles = files.filter(file => !loadedSubtitles.some(sub => sub.name === file.name));
        if (newFiles.length === 0) {
            e.target.value = null;
            return;
        }

        const newSubtitles = await Promise.all(newFiles.map(file => new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = event => {
                let vttContent = file.name.endsWith('.srt') ? srtToVtt(event.target.result) : file.name.endsWith('.ass') ? assToVtt(event.target.result) : event.target.result;
                resolve({ name: file.name, vtt: vttContent, cues: parseVttCues(vttContent) });
            };
            reader.readAsText(file);
        })));

        loadedSubtitles.push(...newSubtitles);
        updateSubtitleSelectors();
        e.target.value = null;
    });
    
    document.addEventListener('click', e => {
        if (settingsPanel.style.display === 'block' && !settingsPanel.contains(e.target) && !settingsBtn.contains(e.target)) {
            settingsPanel.style.display = 'none';
        }
    });

    window.addEventListener('beforeunload', () => { 
        savePlaybackPosition();
        if (video.src && video.src.startsWith('blob:')) URL.revokeObjectURL(video.src); 
    });

    const init = () => {
        playPauseBtn.innerHTML = playIconSVG;
        muteBtn.innerHTML = volumeIcon;
        fullscreenBtn.innerHTML = fullscreenEnterIcon;
        volumeFilled.style.width = `${video.volume * 100}%`;
        updateNavButtons();
        loadSettings();
    };
    init();
});
</script>

</body>
</html>
